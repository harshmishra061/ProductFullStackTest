<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Products Page</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; }
        table { border-collapse: collapse; width: 100%; }
        th, td { padding: 0.75rem; text-align: left; }
        th { background-color: #f3f4f6; }
        tr:nth-child(even) { background-color: #f9fafb; }
        tr:hover { background-color: #e5e7eb; }
        .action-btn { padding: 0.25rem 0.75rem; margin-right: 0.5rem; border-radius: 0.25rem; font-size: 0.875rem; font-weight: 500; cursor: pointer; }
        .update-btn { background-color: #3b82f6; color: white; }
        .update-btn:hover { background-color: #2563eb; }
        .delete-btn { background-color: #ef4444; color: white; }
        .delete-btn:hover { background-color: #b91c1c; }
        .action-cell { display: flex; gap: 0.5rem; }
        .action-cell a { flex: 1; text-align: center; }
        #get-products-btn { padding: 0.5rem 1rem; background-color: #10b981; color: white; border-radius: 0.25rem; cursor: pointer; margin-bottom: 1rem; }
        #get-products-btn:hover { background-color: #059669; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

<header class="bg-white shadow-md p-4 mb-6">
    <div class="container mx-auto">
        <h1 class="text-xl font-bold">My Store</h1>
    </div>
</header>

<main class="container mx-auto px-4">
    <h1 class="text-2xl font-bold mb-4">All Products</h1>
    <div class="mb-4">
        <input type="text" id="search-input"
               class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
               placeholder="Search products by title...">
    </div>
    <button id="get-products-btn">Get Products</button>

    <table class="min-w-full border border-gray-300 mb-6">
        <thead>
        <tr>
            <th class="border-b border-gray-300">Title</th>
            <th class="border-b border-gray-300">Vendor</th>
            <th class="border-b border-gray-300">Published At</th>
            <th class="border-b border-gray-300">Actions</th>
        </tr>
        </thead>
        <tbody id="products-tbody">
        </tbody>
    </table>

    <dialog id="delete-dialog">
        <form method="dialog" class="p-4">
            <p>Are you sure you want to delete this product?</p>
            <menu class="flex gap-2 mt-4">
                <button id="cancel-btn">Cancel</button>
                <button id="confirm-btn" value="default">Delete</button>
            </menu>
        </form>
    </dialog>

    <section class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-xl font-semibold mb-4">Add New Product</h2>
        <form id="add-product-form" class="space-y-4">
            <div>
                <label for="title" class="block text-gray-700 font-medium">Product Name</label>
                <input type="text" id="title" name="title"
                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                       placeholder="Enter product name" required>
            </div>
            <div>
                <label for="vendor" class="block text-gray-700 font-medium">Vendor</label>
                <input type="text" id="vendor" name="vendor"
                       class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500"
                       placeholder="Enter vendor name" required>
            </div>
            <button type="submit"
                    class="w-full bg-green-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-green-700">
                Submit
            </button>
        </form>
    </section>

</main>

<footer class="bg-white shadow-inner mt-10 p-4 text-center text-gray-500">
    &copy; 2025 My Store. All rights reserved.
</footer>

<script>
    const getProductsBtn = document.getElementById('get-products-btn');
    const tbody = document.getElementById('products-tbody');
    const form = document.getElementById('add-product-form');


    const dialog = document.getElementById('delete-dialog');
    let productIdToDelete;
    let deleteButtonReference;

    function confirmDelete(id, buttonRef) {
        productIdToDelete = id;
        deleteButtonReference = buttonRef;
        dialog.showModal();
    }

    document.getElementById('confirm-btn').addEventListener('click', async () => {
        try {
            const response = await fetch(`/products/delete/${productIdToDelete}`, {
                method: 'DELETE'
            });
            if (!response.ok) throw new Error('Delete failed');

            // Remove the row from the table
            deleteButtonReference.closest('tr').remove();
        } catch (err) {
            console.error(err);
            alert('Error deleting product');
        } finally {
            dialog.close();
        }
    });

    document.getElementById('cancel-btn').addEventListener('click', () => {
        dialog.close();
    });

    function renderProducts(products) {
        tbody.innerHTML = products;
    }
    getProductsBtn.addEventListener('click', async () => {
        try {
            const response = await fetch(`/products`);
            if (!response.ok) throw new Error('Search failed');
            const html = await response.text()
            renderProducts(html);
        } catch (err) {
            console.error(err);
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = document.getElementById('title').value;
        const vendor = document.getElementById('vendor').value;

        try {
            const response = await fetch('/products/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, vendor })
            });

            if (!response.ok) throw new Error('Failed to add product');

            const response2 = await fetch(`/products`);
            const products = await response2.text();
            renderProducts(products);
        } catch (err) {
            console.error(err);
            alert('Error adding product');
        }
    });

    const searchInput = document.getElementById('search-input');

    searchInput.addEventListener('input', async () => {
        const query = searchInput.value.trim();
        try {
            const response = await fetch(`/products/search?title=${encodeURIComponent(query)}`);
            if (!response.ok) throw new Error('Search failed');
            const products = await response.text();
            renderProducts(products);
        } catch (err) {
            console.error(err);
        }
    });
</script>

</body>
</html>
